Object.defineProperty(exports,"__esModule",{value:true});var _jsxFileName='app/view/EventsView.js';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require('react');var _react2=_interopRequireDefault(_react);var _reactNativeElements=require('react-native-elements');var _reactNative=require('react-native');var _EventsModelAdapter=require('./adapters/EventsModelAdapter');var _EventsModelAdapter2=_interopRequireDefault(_EventsModelAdapter);var _EventItem=require('./components/EventItem');var _EventItem2=_interopRequireDefault(_EventItem);var _Styles=require('../constants/Styles');var _Styles2=_interopRequireDefault(_Styles);var _Constants=require('../constants/Constants');var _Constants2=_interopRequireDefault(_Constants);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i];}return arr2;}else{return Array.from(arr);}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var EventsView=function(_Component){_inherits(EventsView,_Component);_createClass(EventsView,[{key:'componentWillMount',value:function componentWillMount(){this.props.navigation.setParams({scrollToTop:this._onPressGoToTop.bind(this)});}},{key:'componentDidMount',value:function componentDidMount(){_reactNative.NetInfo.addEventListener('connectionChange',this._handleConnectionChange.bind(this));}},{key:'componentWillUnmount',value:function componentWillUnmount(){_reactNative.NetInfo.removeEventListener('connectionChange',this._handleConnectionChange.bind(this));}}]);function EventsView(props){_classCallCheck(this,EventsView);var _this=_possibleConstructorReturn(this,(EventsView.__proto__||Object.getPrototypeOf(EventsView)).call(this,props));_this.mAdapter=new _EventsModelAdapter2.default();_this.state={data:[],refreshing:false,internet:null,firstLoad:true,coolInternet:true};_this.page=1;_this.realImageSaved={};_this.noMorePages=false;_this.loadingMore=false;_this.hasScroll=false;return _this;}_createClass(EventsView,[{key:'_handleConnectionChange',value:function _handleConnectionChange(connectionInfo){var _this2=this;console.log("Firs load or connection get changed:",connectionInfo.type);if(this.state.internet&&connectionInfo.type==='none'){console.log("Firs load or lost internet connection");this.loadingMore=false;console.log("setState 6");this.setState({internet:connectionInfo.type!=='none'});}else if(!this.state.internet&&connectionInfo.type!=='none'){console.log("Firs load or recupered internet connection");console.log("setState 7");this.setState({internet:connectionInfo.type!=='none'},function(){if(_this2.state.firstLoad)_this2._handleRefresh();});}else if(this.state.internet===null&&connectionInfo.type==='none'){this._handleRefresh();}}},{key:'_getEventsData',value:function _getEventsData(){var _this3=this;console.log("requested page n: "+this.page);this.mAdapter.getEventsData(this.page,this.state.internet).then(function(res){if(res){console.log("data page "+_this3.page,res);for(var key in res.realImageSaved){if(res.realImageSaved.hasOwnProperty(key)){_this3.realImageSaved[key]=res.realImageSaved[key];}}_this3._updateNewData(res.eventsData.results);}else{console.log("No internet connection and no local data");}}).catch(function(error){if(error.errCode==='no-page'){console.log("getEventsData Catch -> no-page",error);_this3.noMorePages=true;console.log("setState 2");_this3.page-=1;_this3.setState({refreshing:false});}else if(error.errCode==='time-out'){console.log("getEventsData Catch -> time-out",error);if(_this3.state.firstLoad&&error.localData){console.log("time-out first load and data not null");var ids=[];for(i=0;i<error.localData.results.length;i++){ids.push(parseInt(error.localData.results[i].id));}var trueReturn={};for(i=0;i<ids.length;i++){_this3.realImageSaved[ids[i]]=true;}_this3.setState({coolInternet:false,data:error.localData.results});_this3._getEventsData();}else{_this3.setState({coolInternet:false});_this3._getEventsData();}}else{console.log("getEventsData Error: ",error);_this3.setState({internet:false,refreshing:false});}});}},{key:'_updateNewData',value:function _updateNewData(eventsData){var _this4=this;console.log("this.realImageSaved",this.realImageSaved);console.log("setState 1");this.setState({data:this.page===1?eventsData:[].concat(_toConsumableArray(this.state.data),_toConsumableArray(eventsData)),refreshing:false,firstLoad:false,coolInternet:true},function(){_this4.loadingMore=false;});}},{key:'_handleRefresh',value:function _handleRefresh(){var _this5=this;console.log("handle refresssssssh!!");console.log("setState 4");this.page=1;this.setState({refreshing:true},function(){_this5._handleRefreshBeforeGetEvents();});}},{key:'_handleRefreshBeforeGetEvents',value:function _handleRefreshBeforeGetEvents(){this.noMorePages=false;this.hasScroll=false;this.realImageSaved={};this._getEventsData();}},{key:'_handleLoadMore',value:function _handleLoadMore(data){console.log("they are asking me to load more: ",data.distanceFromEnd);var boolResult=data.distanceFromEnd>parseFloat("-150");console.log("checking... ",boolResult);if(!this.noMorePages&&this.state.internet&&data.distanceFromEnd>parseFloat("-150")){this.loadingMore=true;console.log("handle load more");this.page+=1;this._getEventsData();}}},{key:'_renderFooter',value:function _renderFooter(){if(this.state.refreshing||!this.state.internet||this.noMorePages)return null;return _react2.default.createElement(_reactNative.View,{style:{paddingVertical:20},__source:{fileName:_jsxFileName,lineNumber:206}},_react2.default.createElement(_reactNative.ActivityIndicator,{animating:true,size:'large',__source:{fileName:_jsxFileName,lineNumber:207}}));}},{key:'onPressItem',value:function onPressItem(itemId){this.props.onPressItem(itemId);}},{key:'_handleOnScroll',value:function _handleOnScroll(e){var offset=e.nativeEvent.contentOffset.y;if(!this.hasScroll&&offset>0){this.hasScroll=true;}else if(this.hasScroll&&offset===0){this.hasScroll=false;}}},{key:'_onPressGoToTop',value:function _onPressGoToTop(){if(!this.state.refreshing){if(this.hasScroll){console.log("SCROLL INFO: scroll to top");this.flatListRef.scrollToOffset({index:0});}else{}this.hasScroll=false;}}},{key:'_firstLoadComponent',value:function _firstLoadComponent(){return _react2.default.createElement(_reactNative.View,{__source:{fileName:_jsxFileName,lineNumber:243}},_react2.default.createElement(_reactNative.Text,{__source:{fileName:_jsxFileName,lineNumber:244}},'carregant...'));}},{key:'render',value:function render(){var _this6=this;console.log("super render",this.state.data);return _react2.default.createElement(_reactNative.View,{style:_Styles2.default.eventsListConainer,__source:{fileName:_jsxFileName,lineNumber:252}},this.state.internet?_react2.default.createElement(_reactNative.Text,{__source:{fileName:_jsxFileName,lineNumber:254}},'hi ha internet'):_react2.default.createElement(_reactNative.Text,{__source:{fileName:_jsxFileName,lineNumber:256}},'NO hi ha internet'),this.state.refreshing?_react2.default.createElement(_reactNative.Text,{__source:{fileName:_jsxFileName,lineNumber:259}},'refreshing...'):null,!this.state.coolInternet?_react2.default.createElement(_reactNative.Text,{__source:{fileName:_jsxFileName,lineNumber:264}},'Not cool internet'):null,this.state.firstLoad&&!this.state.data.length?this._firstLoadComponent():_react2.default.createElement(_reactNative.FlatList,{ref:function ref(_ref2){_this6.flatListRef=_ref2;},data:this.state.data,renderItem:function renderItem(_ref){var item=_ref.item,index=_ref.index;return _react2.default.createElement(_EventItem2.default,{realImageSaved:_this6.realImageSaved[item.id],item:item,index:index,mAdapter:_this6.mAdapter,onPressItem:_this6.onPressItem.bind(_this6,item.id),__source:{fileName:_jsxFileName,lineNumber:275}});},onScroll:this._handleOnScroll.bind(this),keyExtractor:function keyExtractor(item){return item.id;},ListFooterComponent:this._renderFooter.bind(this),onRefresh:this._handleRefresh.bind(this),refreshing:this.state.refreshing,onEndReached:this._handleLoadMore.bind(this),onEndReachedThreshold:0.8,__source:{fileName:_jsxFileName,lineNumber:271}}));}}]);return EventsView;}(_react.Component);exports.default=EventsView;