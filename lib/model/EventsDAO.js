Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _reactNative=require('react-native');var _Constants=require('../constants/Constants');var _Constants2=_interopRequireDefault(_Constants);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var EventsDAO=function(){function EventsDAO(){_classCallCheck(this,EventsDAO);this.RNFS=require('react-native-fs');this.path=this.RNFS.DocumentDirectoryPath+"/events";console.log("path DAO",this.path);}_createClass(EventsDAO,[{key:'_savePage',value:function _savePage(pageId){var _this=this;var filepath=this.path+"/local/aux/page"+pageId+".json";var destPath=this.path+"/local/page"+pageId+".json";var promise=this.RNFS.exists(destPath).then(function(exists){console.log("saving page "+pageId);if(exists){_this.RNFS.unlink(destPath).then(function(){console.log("file deleted");_this.RNFS.moveFile(filepath,destPath);});}else{_this.RNFS.moveFile(filepath,destPath);}});return promise;}},{key:'_checkPage',value:function _checkPage(pageData,pageId){var _this2=this;if(pageId>_Constants2.default.localPages)return{local:false,eventsData:pageData};else{var pagePath=this.path+"/local/page"+pageId+".json";return this.RNFS.exists(pagePath).then(function(exists){auxExists=exists;if(!exists){return _this2._savePage(pageId);}else{return _this2.RNFS.readFile(pagePath);}}).then(function(fileData){if(auxExists){fileJSON=JSON.parse(fileData);if(JSON.stringify(fileJSON)!==JSON.stringify(pageData)){return _this2._savePage(pageId);}else{return{local:true,eventsData:pageData};}}else{return{local:false,eventsData:pageData};}}).then(function(res){if(res)return{local:res.local,eventsData:res.eventsData};return{local:false,eventsData:pageData};});}}},{key:'downloadThumbnails',value:function downloadThumbnails(pageData,localData){var _this3=this;var promises=[];for(i=0;i<pageData.results.length;i++){var singleProm=this.RNFS.downloadFile({fromUrl:pageData.results[i].picture.thumbnail,toFile:this.path+"/thumbnailEvent"+pageData.results[i].id+".jpg"});promises.push(singleProm.promise);}return Promise.all(promises).then(function(res){console.log("thumb results",res);return pageData;}).catch(function(error){_this3._throwError('time-out',localData);});}},{key:'getEventsData',value:function getEventsData(pageId,internet){var _this4=this;var pagePath=this.path+"/local/aux/page"+pageId+".json";var pagePathSaved=this.path+"/local/page"+pageId+".json";var url='https://pausabe.com/apps/CBCN/page'+pageId+'.json';return this.RNFS.exists(pagePathSaved).then(function(exists){if(exists)return _this4.RNFS.readFile(pagePathSaved);else return false;}).then(function(fileData){var localData=null;if(fileData)localData=JSON.parse(fileData);if(internet){return _this4.RNFS.mkdir(_this4.path+"/local/aux",{NSURLIsExcludedFromBackupKey:true}).then(function(){return _this4.RNFS.downloadFile({fromUrl:url,toFile:pagePath}).promise;}).then(function(res){if(res.statusCode===200){return _this4.RNFS.readFile(pagePath);}else{throw'no-page';}}).catch(function(error){if(error==='no-page')_this4._throwError('no-page');else _this4._throwError('time-out',localData);}).then(function(fileData){var eventsData=JSON.parse(fileData);return _this4._checkPage(eventsData,pageId);}).then(function(checkRes){console.log("checkRes",checkRes);if(checkRes.local){return checkRes.eventsData;}else{return _this4.downloadThumbnails(checkRes.eventsData,localData);}}).then(function(eventsData){var newIds=[];for(i=0;i<eventsData.results.length;i++){newIds.push(parseInt(eventsData.results[i].id));}var falseReturn={};for(i=0;i<newIds.length;i++){falseReturn[newIds[i]]=false;}if(pageId>_Constants2.default.localPages){return{eventsData:eventsData,realImageSaved:falseReturn};}else{return _this4._realImagesExist(newIds,_this4.path+"/local/images/").then(function(realExists){if(realExists){console.log("realExists",realExists);if(realExists.deleteIds.length>0){return _this4._deleteImages(realExists.deleteIds).then(function(){return{eventsData:eventsData,realImageSaved:realExists.bools};});}else{return{eventsData:eventsData,realImageSaved:realExists.bools};}}else{return{eventsData:eventsData,realImageSaved:falseReturn};}});}});}else if(pageId<=_Constants2.default.localPages){console.log("handling no internet but maybe local data");var newIds=[];for(i=0;i<localData.results.length;i++){newIds.push(parseInt(localData.results[i].id));}var trueReturn={};for(i=0;i<newIds.length;i++){trueReturn[newIds[i]]=true;}if(fileData)return{eventsData:localData,realImageSaved:trueReturn};return false;}else{return{eventsData:null,realImageSaved:false};}});}},{key:'_throwError',value:function _throwError(errCode,localData){throw{errCode:errCode,localData:localData};}},{key:'_deleteImages',value:function _deleteImages(imageIds){console.log("imageIds",imageIds);var promises=[];for(i=0;i<imageIds.length;i++){var auxImagePath=this.path+"/local/images/image-"+imageIds[i]+".jpg";console.log("should delte:",imageIds[i]);promises.push(this.RNFS.unlink(auxImagePath));}return Promise.all(promises);}},{key:'_realImagesExist',value:function _realImagesExist(newIds,folderPath){var _this5=this;return this.RNFS.exists(folderPath).then(function(folderExists){if(folderExists)return _this5.RNFS.readdir(folderPath);return false;}).then(function(res){if(res){var oldIds=[];for(i=0;i<res.length;i++){var auxId=parseInt(res[i].split("-")[1].split(".")[0]);oldIds.push(auxId);}var distinctIds=[];var oldContainsNew={};for(i=0;i<oldIds.length;i++){if(!newIds.includes(oldIds[i])){distinctIds.push(oldIds[i]);oldContainsNew[oldIds[i]]=false;}else{oldContainsNew[oldIds[i]]=true;}}console.log("distinctIds",distinctIds);console.log("oldContainsNew",oldContainsNew);return{bools:oldContainsNew,deleteIds:distinctIds};}return false;});}},{key:'saveLocalImage',value:function saveLocalImage(itemId,imagePath){var _this6=this;var imageDestPath=this.path+"/local/images/image-"+itemId+".jpg";return this.RNFS.mkdir(this.path+"/local/images",{NSURLIsExcludedFromBackupKey:true}).then(function(){console.log("descarregant real ("+itemId+"): ",imagePath);return _this6.RNFS.downloadFile({fromUrl:imagePath,toFile:imageDestPath}).promise;});}}]);return EventsDAO;}();exports.default=EventsDAO;